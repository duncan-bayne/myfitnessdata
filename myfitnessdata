#!/usr/bin/sbcl --script

(require :sb-posix)
(load (merge-pathnames "quicklisp/setup.lisp" (user-homedir-pathname)))
(ql:quickload '("drakma" "xmls"))

(defun show-usage () 
  (format t "Usage: myfitnessdata USERNAME PASSWORD~%~%")
  (format t "  USERNAME  Your MyFitnessPal username~%")
  (format t "  PASSWORD  Your MyFitnessPal password~%~%")
  (format t "Example:~%~%")
  (format t "  ./myfitnessdata bob b0bsp4ss! weights.csv~%~%"))

(defun scrape (username password)
  (let ((cookie-jar (make-instance 'drakma:cookie-jar)))
    (drakma:http-request "http://www.myfitnesspal.com/account/login"
			 :method :post
			 :parameters `(("username" . ,username)
				       ("password" . ,password))
			 :cookie-jar cookie-jar)
    (setq body (drakma:http-request "http://www.myfitnesspal.com/measurements/edit?page=1&type=1"
				    :cookie-jar cookie-jar))
    (format t body)))

(if (= (length sb-ext:*posix-argv*) 3)
    (scrape (nth 0 sb-ext:*posix-argv*) (nth 1 sb-ext:*posix-argv*) (nth 2 sb-ext:*posix-argv*))
  (show-usage))
